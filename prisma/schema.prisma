// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init


generator client {
  provider             = "prisma-client-py"
  interface            = "asyncio"
  recursive_type_depth = 5
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model Dortoir {
  id            String         @id @default(auto()) @map("_id") @db.ObjectId
  code          String         @unique
  name          String
  capacity      Int
  current_count Int            @default(0)
  gender        String         // "M" ou "F"
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  registrations Registration[]

  @@map("dortoirs")
}

model Registration {
  id                  String    @id @default(auto()) @map("_id") @db.ObjectId
  matricule           String    @unique
  nom                 String
  prenom              String
  sexe                String
  age                 Int
  niveau_academique   String
  dortoir_code        String
  dortoir             Dortoir   @relation(fields: [dortoir_code], references: [code])
  allergie            String?   @default("RAS")
  antecedent_medical  String?   @default("Néant")
  payment_status      String    @default("completed") // "pending", "awaiting_proof", "completed"
  payment_timestamp   DateTime?
  transaction_id      String?   @unique
  // qr_code_data        String?   // Chaîne pour générer le QR code
  photo_url           String?
  validated           Boolean   @default(false)
  registration_date   DateTime  @default(now())
  updated_at          DateTime  @updatedAt
  commune_habitation  String
  receipt_url         String?
  contact_parent      String
  contact_seminariste String?

  bulletins Bulletin[]
  seminaristes Seminariste[]
  notes        Note[]

  @@map("registrations")
}

// ============================================
// MODULE SCIENTIFIQUE
// ============================================

model Seminariste {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  matricule   String   @unique
  registration Registration @relation(fields: [matricule], references: [matricule])
  niveau       String?   // NIVEAU DU SÉMINAIRE

  @@map("seminaristes")
}

model Note {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  matricule     String
  seminariste   Registration @relation(fields: [matricule], references: [matricule])

  note          Float    // sur 20
  observation   String?
  type          String?   // "TEST_ENTREE", "EVALUATION", "SUIVI"
  libelle       String?  // ex: "Test de niveau", "Evaluation jour 3"

  created_at    DateTime @default(now())
  updated_at    DateTime? @default(now())
  created_by    String

  @@map("notes")
}

model Bulletin {
  id                String       @id @default(auto()) @map("_id") @db.ObjectId
  numero            String       @unique
  matricule         String
  seminariste       Registration @relation(fields: [matricule], references: [matricule])
  annee_scolaire    String       // "AnNour25"
  moyenne_generale  Float
  total_coefficient Float
  rang              Int?
  effectif_classe   Int?
  mention           String?      // "Excellent", "Très bien", "Bien", "Passable"
  observations      String?
  date_conseil      DateTime?
  pdf_url           String?
  generated_at      DateTime     @default(now())
  generated_by      String

  @@map("bulletins")
}

// ============================================
// MODULE FINANCES
// ============================================

model Transaction {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId
  reference         String    @unique
  type              String    // "ENTREE" ou "SORTIE"
  categorie         String    // "Inscription", "Don", "Achat matériel", cas social, etc.
  montant           Float
  devise            String    @default("FCFA")
  libelle           String
  description       String?
  beneficiaire      String?   // Nom du bénéficiaire (pour sorties)
  payeur            String?   // Nom du payeur (pour entrées)
  matricule         String?   // Si lié à un séminariste
  mode_paiement     String    // "Wave", "Espèces", "Virement", "Mobile Money"
  numero_compte     String?
  piece_justificative String? // URL du reçu/facture
  statut            String    @default("validee") // "validee", "en_attente", "annulee"
  date_transaction  DateTime
  created_by        String    // ID de l'utilisateur qui a créé
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt
  is_deleted        Boolean   @default(false)
  deleted_at        DateTime?
  deleted_by        String?
  deleted_reason    String?
  
  // Traçabilité
  audit_logs        AuditLog[]

  @@map("transactions")
}

model AuditLog {
  id             String      @id @default(auto()) @map("_id") @db.ObjectId
  transaction_id String
  transaction    Transaction @relation(fields: [transaction_id], references: [id])
  action         String      // "CREATE", "UPDATE", "DELETE", "RESTORE"
  field_changed  String?     // Champ modifié (pour UPDATE)
  old_value      String?     // Ancienne valeur
  new_value      String?     // Nouvelle valeur
  modified_by    String      // ID utilisateur
  modified_at    DateTime    @default(now())
  ip_address     String?
  user_agent     String?

  @@map("audit_logs")
}

model RapportFinancier {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  numero          String   @unique
  titre           String
  periode_debut   DateTime
  periode_fin     DateTime
  type_rapport    String   // "mensuel", "trimestriel", "annuel", "personnalise"
  total_entrees   Float
  total_sorties   Float
  solde           Float
  nb_transactions Int
  pdf_url         String?
  generated_by    String
  generated_at    DateTime @default(now())
  commentaires    String?

  @@map("rapports_financiers")
}

// ============================================
// SYSTÈME D'AUTHENTIFICATION 
// ============================================

model User {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  email      String   @unique
  username   String   @unique
  password   String   // Hash bcrypt
  nom        String
  prenom     String
  role       String   // "admin", "scientifique", "finances", "consultation"
  is_active  Boolean  @default(true)
  last_login DateTime?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("users")
}